// These queries check telemetry from the Exploit Guard rule: Rule: Block Office applications from creating child processes
// Read more about it here: https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-exploit-guard/attack-surface-reduction-exploit-guard
// Oftentimes organizations enable this rule in audit mode and check the results before setting block mode.
// You can use query #2 to measure the rule impact on your network in audit mode before turning it to block mode.
// Query #1 is used after setting it to block mode - to analyze the block stats.
// Tags: #ExploitGuard

//Query #1: count blocks
MiscEvents
| where ActionType == "ProcessBlockCreatingChildProcess" and EventTime > ago(7d)
| project BlockedProcess=FileName, ParentProcess=InitiatingProcessFileName, IsAudit=toboolean(parsejson(AdditionalFields).IsAudit)
| where IsAudit == 0
| summarize MachineCount=dcount(MachineId), RuleHits=count() by BlockedProcess, ParentProcess
| sort by MachineCount desc

// Query #2: investigate audit events - before turning the rule on in block mode
let minTime = ago(7d);
// Enrich the ExploitGuard events with column saying if there was a nearby Windows Defender ATP alert or not.
// If there was an alert, so this is probably malware, and it's good that it will be blocked.
// If there was no alert, so it requires further analysis to determine if this is a clean file or some malware that was missed.
let alerts =
    AlertEvents
    | where EventTime > minTime
    | project ComputerName, DetectedEventTime=EventTime;
MiscEvents
| where ActionType == "ProcessBlockCreatingChildProcess" and EventTime > minTime
| project BlockedProcess=FileName, ParentProcess=InitiatingProcessFileName, IsAudit=toboolean(parsejson(AdditionalFields).IsAudit), ComputerName, EventTime
| where IsAudit == 1
| join kind=leftouter (alerts) on ComputerName
| extend HasNearbyAlert = abs(EventTime - DetectedEventTime) between (0min .. 5min)
| summarize MachineCount=dcount(ComputerName),
            RuleHits=count(),
            NearbyAlertPercent=countif(HasNearbyAlert)*100.0 / count() 
            by BlockedProcess, ParentProcess, IsAudit
| sort by MachineCount desc
