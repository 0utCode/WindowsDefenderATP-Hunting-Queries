// This query looks for network connections that are DNS-related (assuming port 53)
//   that are not resolved from private IP space, that is to say anything that is not resolved by local DNS servers.
//   Typically corporate assets should be using DHCP-provided DNS servers which are typically on internal/private
//   IP space.  Also, when mobile/remote assets are at coffee shops and/or home, they are most likely still on private IP space
//   Sometimes port 53 is used for data exfiltration and/or C&C traffic so this query has multiple uses: 
//      1. Device Misconfiguration
//      2. Data Exfiltration
//      3. Command and Control
NetworkCommunicationEvents 
| where EventTime > ago(7d)
| where 
        // Look for 10.x.x.x/8 Private Subnet out of RFC 1918
        RemoteIP !startswith "10." and 
        // Look for 192.168.x.x/16 Private Subnet out of RFC 1918
        RemoteIP !startswith "192.168" and 
        // Look for 172.16.x.x/12 - 172.31.x.x/12 Private Subnet out of RFC 1918
        RemoteIP !startswith "172.16" and
        RemoteIP !startswith "172.17" and
        RemoteIP !startswith "172.18" and
        RemoteIP !startswith "172.19" and
        RemoteIP !startswith "172.20" and
        RemoteIP !startswith "172.21" and
        RemoteIP !startswith "172.22" and
        RemoteIP !startswith "172.23" and
        RemoteIP !startswith "172.24" and
        RemoteIP !startswith "172.25" and
        RemoteIP !startswith "172.26" and
        RemoteIP !startswith "172.27" and
        RemoteIP !startswith "172.28" and
        RemoteIP !startswith "172.29" and
        RemoteIP !startswith "172.30" and
        RemoteIP !startswith "172.31"
| where RemotePort == 53
| summarize makeset(InitiatingProcessFileName) by ComputerName,RemoteIP

